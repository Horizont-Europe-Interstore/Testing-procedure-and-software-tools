events {
    worker_connections 1024;
}

http {
   
    log_format debug '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_accept" '
                     'upstream_response_time=$upstream_response_time '
                     'request_time=$request_time';
    
    access_log /var/log/nginx/access.log debug;
    error_log /var/log/nginx/error.log debug;
    
  
    ignore_invalid_headers off;
    underscores_in_headers on;
    merge_slashes off;
    
    upstream springboot {
        server java-backend:8080;
    }

    ssl_protocols TLSv1.2;
    server {
        listen 443 ssl default_server;
        server_name _;

    
    ssl_certificate /etc/nginx/certs/cert_key.pem;
    ssl_certificate_key /etc/nginx/certs/cert_key.pem;


        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-CCM8:ECDHE-ECDSA-AES256-CCM8:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

       
        ssl_client_certificate /etc/nginx/certs/ca.pem;
        ssl_verify_client optional_no_ca;

     
        location /test {
            return 200 "nginx is working";
            add_header Content-Type text/plain;
        }

        location /test-results {
    
            access_log /var/log/nginx/proxy.log debug;
            
            proxy_pass http://springboot/test-results;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_http_version 1.1;
            proxy_buffering off;
            keepalive_timeout 0;
            
           
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

       
        location / {
            
            access_log /var/log/nginx/proxy.log debug;

           
            access_by_lua_block {
                local cert_pem = ngx.var.ssl_client_cert
                if cert_pem and cert_pem ~= "" then
                    -- extract the base64 body between the PEM markers
                    local body = cert_pem:match('-----BEGIN CERTIFICATE-----%s*(.-)%s*-----END CERTIFICATE-----')
                    if body then
                        body = body:gsub('%s+', '')
                        local der = ngx.decode_base64(body)
                        if der and #der >= 1 then
                            local hash = ngx.sha256_bin(der)
                            if hash and #hash >= 20 then
                                -- compute LFDI (first 20 bytes) as hex
                                local lfdi_tbl = {}
                                for i = 1, 20 do
                                    lfdi_tbl[#lfdi_tbl + 1] = string.format('%02x', string.byte(hash, i))
                                end
                                local lfdi_hex = table.concat(lfdi_tbl)
                                ngx.req.set_header('X-LFDI', lfdi_hex)

                                -- take first 5 bytes, build 40-bit integer for SFDI
                                local sfdi_base = 0
                                for i = 1, 5 do
                                    sfdi_base = sfdi_base * 256 + string.byte(hash, i)
                                end
                                -- shift right 4 bits
                                sfdi_base = math.floor(sfdi_base / 16)
                                -- compute decimal check digit
                                local v = sfdi_base
                                local sum = 0
                                if v == 0 then
                                    sum = 0
                                else
                                    while v > 0 do
                                        sum = sum + (v % 10)
                                        v = math.floor(v / 10)
                                    end
                                end
                                local cd = (10 - (sum % 10)) % 10
                                local sfdi = sfdi_base * 10 + cd
                                ngx.req.set_header('X-SFDI', tostring(sfdi))

                                -- Log computed values to nginx error log (notice level)
                                ngx.log(ngx.NOTICE, "Computed LFDI: ", lfdi_hex, "  SFDI: ", tostring(sfdi))
                            end
                        end
                    end
                end
            }

            proxy_pass http://springboot;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Client-Subject $ssl_client_s_dn;
            proxy_set_header X-Client-Fingerprint $ssl_client_fingerprint;
            proxy_set_header X-Client-Cert $ssl_client_cert;
            proxy_http_version 1.1;
            proxy_buffering off;
            keepalive_timeout 0;
            

            header_filter_by_lua_block {
                local uri = ngx.var.uri or ""
                local status = ngx.status
                if uri == "/edev" and status == 200 then
                    ngx.header["Connection"] = "close"
                end
            }
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
    }

}