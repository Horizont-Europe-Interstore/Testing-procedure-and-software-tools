log_format debug '$remote_addr - $remote_user [$time_local] "$request" '
                 '$status $body_bytes_sent "$http_referer" '
                 '"$http_user_agent" "$http_accept" '
                 'upstream_response_time=$upstream_response_time '
                 'request_time=$request_time '
                 'lfdi="$sent_http_x_server_lfdi" '
                 'sfdi="$sent_http_x_server_sfdi"';

access_log /dev/stdout debug;
error_log /dev/stderr debug;

ignore_invalid_headers off;
underscores_in_headers on;
merge_slashes off;

upstream springboot {
    server localhost:8080;
    keepalive 32;
}

ssl_protocols TLSv1.2;

server {
    listen 10.40.160.184:443 ssl default_server;
    server_name 10.40.160.184;

    ssl_certificate /etc/nginx/certs/cert_key.pem;
    ssl_certificate_key /etc/nginx/certs/cert_key.pem;

    ssl_protocols TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-CCM8:ECDHE-ECDSA-AES256-CCM8:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # Client certificate settings for LFDI/SFDI calculation
    ssl_client_certificate /etc/nginx/certs/ca.pem;
    ssl_verify_client optional_no_ca;
    ssl_verify_depth 4;

    location /test {
        return 200 "nginx is working";
        add_header Content-Type text/plain;
    }

    location /test-results {
        access_log /dev/stdout debug;
        
        proxy_pass http://springboot/test-results;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_http_version 1.1;
        proxy_buffering off;
        keepalive_timeout 0;
        
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location / {
        access_log /dev/stdout debug;
        error_log /dev/stderr debug;
        
        proxy_pass http://springboot;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Client-Cert $ssl_client_cert;
        proxy_set_header X-Client-Subject $ssl_client_s_dn;
        proxy_set_header X-Client-Fingerprint $ssl_client_fingerprint;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        proxy_buffering off;
        
        # Keep-alive settings for persistent connections
        keepalive_timeout 300s;
        keepalive_requests 1000;
        
        # Pass through LFDI/SFDI headers from Java backend
        proxy_pass_header X-Server-LFDI;
        proxy_pass_header X-Server-SFDI;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}